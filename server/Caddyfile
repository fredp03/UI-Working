{
  # Global options
  auto_https off
  servers {
    protocols h1 h2
  }
}

fredav-videoparty.freeddns.org {
  # Enable compression
  encode zstd gzip

  # CORS and security headers (comprehensive for Safari)
  header {
    # CORS headers for Safari compatibility
    Access-Control-Allow-Origin "https://fredaline-independent-cinema.netlify.app"
    Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Access-Control-Allow-Headers "Authorization, Range, Content-Type, Accept, X-Requested-With"
    Access-Control-Expose-Headers "Accept-Ranges, Content-Length, Content-Range"
    Access-Control-Allow-Credentials "true"
    Access-Control-Max-Age "86400"
    
    # Security headers
    X-Content-Type-Options "nosniff"
    Referrer-Policy "no-referrer"
    Permissions-Policy "autoplay=(), fullscreen=(), microphone=()"
    X-Frame-Options "SAMEORIGIN"
  }

  # Handle preflight requests
  @options method OPTIONS
  respond @options 204

  # Reverse proxy to local Node server
  reverse_proxy localhost:8080 {
    header_up Host {host}
    header_up X-Real-IP {remote}
    header_up X-Forwarded-For {remote}
    header_up X-Forwarded-Proto {scheme}
  }
}
